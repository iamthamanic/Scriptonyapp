/**
 * ğŸ’¾ useEditorSave - Debounced Save fÃ¼r Tiptap Editor
 * 
 * Hook speziell fÃ¼r RichTextEditorModal mit:
 * - Debounced Saving (1000ms)
 * - Optimistic UI Updates
 * - Status-Tracking
 */

import { useCallback } from 'react';
import { useDebouncedSave } from './useDebouncedSave';
import { toast } from 'sonner@2.0.3';

export interface EditorSaveOptions {
  sceneId: string;
  sceneTitle: string;
  characters: any[];
  getAccessToken: () => Promise<string | null>;
  updateAPI: (id: string, data: any, token: string) => Promise<any>;
  onOptimisticUpdate: (sceneId: string, content: any) => void;
  onError?: () => void;
}

export function useEditorSave(options: EditorSaveOptions) {
  const {
    sceneId,
    sceneTitle,
    characters,
    getAccessToken,
    updateAPI,
    onOptimisticUpdate,
    onError,
  } = options;

  // Debounced save function
  const { save, status, lastSaved } = useDebouncedSave({
    delay: 1000, // 1 second debounce
    onSave: async (jsonDoc: any) => {
      console.log('[useEditorSave] ğŸ’¾ Executing save for scene:', sceneId);
      
      const token = await getAccessToken();
      if (!token) {
        throw new Error('No auth token');
      }

      // Update in backend
      await updateAPI(sceneId, {
        title: sceneTitle,
        metadata: {
          content: jsonDoc,
          characters: characters || [],
        },
      }, token);

      console.log('[useEditorSave] âœ… Save complete');
    },
    onError: (error) => {
      console.error('[useEditorSave] âŒ Save failed:', error);
      toast.error('Fehler beim Speichern');
      onError?.();
    },
  });

  // Handle content change from editor
  const handleContentChange = useCallback((jsonDoc: any) => {
    console.log('[useEditorSave] ğŸ“ Content changed, scheduling save...');
    
    // Optimistic update (instant UI)
    onOptimisticUpdate(sceneId, jsonDoc);
    
    // Debounced save (after 1000ms)
    save(jsonDoc);
  }, [sceneId, save, onOptimisticUpdate]);

  return {
    handleContentChange,
    saveStatus: status,
    lastSaved,
  };
}
